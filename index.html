<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üê∞ Bunny Clip Tool</title>
  <style>
    :root {
      --pink: #ff4fa0;
      --dark-pink: #d63b85;
      --bg: #0d0d0f;
      --surface: #18181b;
      --surface2: #232328;
      --border: #2e2e36;
      --text: #f0f0f5;
      --muted: #888;
      --green: #22c55e;
      --yellow: #f59e0b;
      --red: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header h1 { font-size: 20px; font-weight: 700; }
    header span.badge {
      background: var(--pink);
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 99px;
      font-weight: 600;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 32px 24px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 700px) {
      .container { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }
    .card h2 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      margin-bottom: 16px;
      outline: none;
      transition: border-color 0.15s;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--pink);
    }
    textarea { resize: vertical; min-height: 120px; line-height: 1.6; }

    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      margin-bottom: 16px;
      position: relative;
    }
    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--pink);
      background: rgba(255, 79, 160, 0.05);
    }
    .upload-zone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      margin: 0;
    }
    .upload-zone .icon { font-size: 36px; margin-bottom: 8px; }
    .upload-zone p { font-size: 14px; color: var(--muted); }
    .upload-zone .file-name { color: var(--pink); font-weight: 600; margin-top: 8px; font-size: 13px; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
      width: 100%;
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-pink { background: var(--pink); color: white; }
    .btn-pink:hover:not(:disabled) { background: var(--dark-pink); }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-outline:hover { border-color: var(--pink); color: var(--pink); }

    /* Titles editor */
    .titles-editor {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .titles-editor .te-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
    }
    .te-body { max-height: 260px; overflow-y: auto; }
    .title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-bottom: 1px solid var(--border);
    }
    .title-row:last-child { border-bottom: none; }
    .title-row input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 13px;
      padding: 4px 0;
      margin: 0;
    }
    .title-row input:focus { outline: none; }
    .title-row .del-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 16px;
      padding: 2px 6px;
      border-radius: 4px;
      transition: color 0.15s;
    }
    .title-row .del-btn:hover { color: var(--red); }
    .te-footer {
      padding: 8px 10px;
      border-top: 1px solid var(--border);
    }
    .add-title-input {
      display: flex;
      gap: 8px;
    }
    .add-title-input input {
      flex: 1;
      margin: 0;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 13px;
    }
    .add-title-input button {
      background: var(--pink);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }

    /* Status panel */
    .status-panel { display: none; }
    .status-panel.visible { display: block; }
    .job-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      background: var(--surface2);
      border-radius: 8px;
      margin-bottom: 14px;
      border: 1px solid var(--border);
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .status-dot.queued { background: var(--yellow); }
    .status-dot.processing { background: var(--pink); animation: pulse 1s infinite; }
    .status-dot.done { background: var(--green); }
    .status-dot.error { background: var(--red); }
    .status-dot.partial { background: var(--yellow); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .clips-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      margin-bottom: 14px;
    }
    .clip-thumb {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px;
      text-align: center;
      font-size: 11px;
      color: var(--muted);
    }
    .clip-thumb .num { font-size: 18px; font-weight: 700; color: var(--pink); display: block; }

    .full-width { grid-column: 1 / -1; }
  </style>
</head>
<body>

<header>
  <span style="font-size:24px">üê∞</span>
  <h1>Bunny Clip Tool</h1>
  <span class="badge">Internal</span>
</header>

<div class="container">

  <!-- Upload Card -->
  <div class="card">
    <h2>üì§ Upload Video</h2>

    <label>Creator Name</label>
    <input type="text" id="creatorName" placeholder="e.g. Sofia, Lena, Maria..." />

    <label>Video File</label>
    <div class="upload-zone" id="uploadZone">
      <input type="file" id="videoFile" accept="video/*" />
      <div class="icon">üé¨</div>
      <p>Drag & drop or click to select video</p>
      <p style="font-size:11px; margin-top:4px; color:#555">MP4, MOV, AVI, MKV ‚Ä¢ Max 4 GB</p>
      <div class="file-name" id="fileName"></div>
    </div>

    <label>Clip Duration (seconds)</label>
    <input type="number" id="clipDuration" value="7" min="3" max="60" />

    <label>Text Style</label>
    <select id="textStyle">
      {% for style in text_styles %}
      <option value="{{ style }}">{{ style }}</option>
      {% endfor %}
    </select>

    <label>Background Music</label>
    <select id="soundId">
      <option value="">üé≤ Random</option>
      {% for sound in sounds %}
      <option value="{{ sound.id }}">{{ sound.name }} ({{ sound.mood }}, {{ sound.bpm }} BPM)</option>
      {% endfor %}
    </select>

    <button class="btn btn-pink" id="processBtn" disabled onclick="startProcessing()">
      ‚úÇÔ∏è Cut & Process Video
    </button>
  </div>

  <!-- Titles Editor Card -->
  <div class="card">
    <h2>üìù Title Templates</h2>
    <p style="font-size:13px; color: var(--muted); margin-bottom: 16px;">
      These titles will be placed on your clips in order. Edit, reorder, or add your own. 
      Saved changes apply to all future jobs.
    </p>

    <div class="titles-editor">
      <div class="te-header">
        <span>TITLES (<span id="titleCount">0</span>)</span>
        <button class="btn-outline" style="width:auto; padding:4px 10px; font-size:11px; border-radius:4px;" onclick="saveTitles()">üíæ Save List</button>
      </div>
      <div class="te-body" id="titlesBody"></div>
      <div class="te-footer">
        <div class="add-title-input">
          <input type="text" id="newTitleInput" placeholder="Add a new title..." onkeydown="if(event.key==='Enter') addTitle()" />
          <button onclick="addTitle()">+ Add</button>
        </div>
      </div>
    </div>
    
    <p style="font-size:11px; color: var(--muted);">
      üí° Titles rotate through your clips. If you have 30 clips and 10 titles, they repeat automatically.
    </p>
  </div>

  <!-- Status Panel -->
  <div class="card full-width status-panel" id="statusPanel">
    <h2>üìä Processing Status</h2>
    <div class="job-status" id="jobStatus">
      <div class="status-dot queued" id="statusDot"></div>
      <div>
        <div style="font-weight:600; font-size:14px" id="statusText">Waiting...</div>
        <div style="font-size:12px; color:var(--muted)" id="statusSub">Job ID: ‚Äî</div>
      </div>
    </div>

    <div class="clips-grid" id="clipsGrid"></div>

    <button class="btn btn-pink" id="downloadBtn" style="display:none" onclick="downloadZip()">
      ‚¨áÔ∏è Download All Clips (.zip)
    </button>
  </div>

</div>

<script>
  let titles = [];
  let currentJobId = null;
  let pollInterval = null;

  // ‚îÄ‚îÄ Load titles on page load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadTitles() {
    const res = await fetch("/api/titles");
    titles = await res.json();
    renderTitles();
  }

  function renderTitles() {
    const body = document.getElementById("titlesBody");
    document.getElementById("titleCount").textContent = titles.length;
    body.innerHTML = titles.map((t, i) => `
      <div class="title-row">
        <span style="color:var(--muted);font-size:11px;min-width:20px">${i+1}</span>
        <input type="text" value="${escHtml(t)}" oninput="titles[${i}]=this.value" />
        <button class="del-btn" onclick="removeTitle(${i})">√ó</button>
      </div>
    `).join("");
  }

  function addTitle() {
    const inp = document.getElementById("newTitleInput");
    const val = inp.value.trim();
    if (!val) return;
    titles.push(val);
    inp.value = "";
    renderTitles();
  }

  function removeTitle(i) {
    titles.splice(i, 1);
    renderTitles();
  }

  async function saveTitles() {
    const res = await fetch("/api/titles", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ titles })
    });
    const data = await res.json();
    alert(`‚úÖ Saved ${data.saved} titles`);
  }

  function escHtml(str) {
    return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;");
  }

  // ‚îÄ‚îÄ File upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById("videoFile").addEventListener("change", function() {
    const file = this.files[0];
    if (file) {
      document.getElementById("fileName").textContent = `üìÅ ${file.name} (${(file.size/1e6).toFixed(1)} MB)`;
      document.getElementById("processBtn").disabled = false;
    }
  });

  const zone = document.getElementById("uploadZone");
  zone.addEventListener("dragover", e => { e.preventDefault(); zone.classList.add("drag-over"); });
  zone.addEventListener("dragleave", () => zone.classList.remove("drag-over"));
  zone.addEventListener("drop", e => {
    e.preventDefault();
    zone.classList.remove("drag-over");
    const file = e.dataTransfer.files[0];
    if (file) {
      document.getElementById("videoFile").files = e.dataTransfer.files;
      document.getElementById("fileName").textContent = `üìÅ ${file.name}`;
      document.getElementById("processBtn").disabled = false;
    }
  });

  // ‚îÄ‚îÄ Process ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function startProcessing() {
    const file = document.getElementById("videoFile").files[0];
    if (!file) return alert("Please select a video file.");

    const btn = document.getElementById("processBtn");
    btn.disabled = true;
    btn.textContent = "‚è≥ Uploading...";

    const formData = new FormData();
    formData.append("video", file);
    formData.append("creator_name", document.getElementById("creatorName").value || "unknown");
    formData.append("clip_duration", document.getElementById("clipDuration").value);
    formData.append("text_style", document.getElementById("textStyle").value);
    formData.append("sound_id", document.getElementById("soundId").value);
    formData.append("custom_titles", titles.join("\n"));

    try {
      const res = await fetch("/api/upload", { method: "POST", body: formData });
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      
      currentJobId = data.job_id;
      showStatusPanel(data.job_id);
      startPolling(data.job_id);

    } catch (err) {
      alert("Upload failed: " + err.message);
      btn.disabled = false;
      btn.textContent = "‚úÇÔ∏è Cut & Process Video";
    }
  }

  function showStatusPanel(jobId) {
    const panel = document.getElementById("statusPanel");
    panel.classList.add("visible");
    panel.scrollIntoView({ behavior: "smooth" });
    document.getElementById("statusSub").textContent = `Job ID: ${jobId}`;
  }

  function startPolling(jobId) {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(() => pollJob(jobId), 2500);
  }

  async function pollJob(jobId) {
    try {
      const res = await fetch(`/api/job/${jobId}`);
      const data = await res.json();
      updateStatusUI(data);
      if (["done", "partial", "error"].includes(data.status)) {
        clearInterval(pollInterval);
        document.getElementById("processBtn").disabled = false;
        document.getElementById("processBtn").textContent = "‚úÇÔ∏è Cut & Process Video";
      }
    } catch (e) {
      console.error(e);
    }
  }

  function updateStatusUI(job) {
    const dot = document.getElementById("statusDot");
    const txt = document.getElementById("statusText");
    const grid = document.getElementById("clipsGrid");
    const dlBtn = document.getElementById("downloadBtn");

    dot.className = `status-dot ${job.status}`;

    const labels = {
      queued: "‚è≥ Queued ‚Äî waiting to start...",
      processing: "‚öôÔ∏è Processing clips...",
      done: `‚úÖ Done! ${job.clip_count} clips ready`,
      partial: `‚ö†Ô∏è Partial ‚Äî ${job.clip_count} clips done (some errors)`,
      error: `‚ùå Error: ${job.error_message || "Unknown error"}`
    };
    txt.textContent = labels[job.status] || job.status;

    if (job.clip_count > 0) {
      grid.innerHTML = Array.from({ length: job.clip_count }, (_, i) => `
        <div class="clip-thumb">
          <span class="num">${i+1}</span>
          clip_${String(i+1).padStart(3,"0")}.mp4
        </div>
      `).join("");
    }

    if (["done", "partial"].includes(job.status) && job.clip_count > 0) {
      dlBtn.style.display = "flex";
    }
  }

  function downloadZip() {
    if (currentJobId) {
      window.location.href = `/api/download/${currentJobId}`;
    }
  }

  // Init
  loadTitles();
</script>
</body>
</html>
